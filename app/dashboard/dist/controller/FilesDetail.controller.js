sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,a,o,s){"use strict";return e.extend("zdashboard.controller.FilesDetail",{DELETED_LEVEL:"X",onInit:function(){var e=this.getView();var t=new a({busy:true,delay:0,editable:false,DELETED_LEVEL:this.DELETED_LEVEL,data:[],bProcessFlowVisible:true});this._InvGUID="00000000-0000-0000-0000-000000000000";var o=new sap.ui.model.json.JSONModel({Header:{documentId:"",fiscalYear:"",companyCode:"",documentDate:"",postingDate:"",supInvParty:"",documentCurrency_code:"",invGrossAmount:"",DocumentHeaderText:"",PaymentTerms:"",AccountingDocumentType:"",InvoicingParty:"",statusFlag:"",mode:""},Items:[{sup_InvoiceItem:"",purchaseOrder:"",purchaseOrderItem:"",referenceDocument:"",refDocFiscalYear:"",refDocItem:"",taxCode:"",documentCurrency_code:"",supInvItemAmount:"",poQuantityUnit:"",quantityPOUnit:"",Plant:"",TaxJurisdiction:"",ProductType:""}]});this._bEditMode;this.getView().setModel(o,"CreateModel");this.getRouter().getRoute("fileDetail").attachPatternMatched(this._onObjectMatchedV2,this);var s=this.getView().getBusyIndicatorDelay();this.setModel(t,"filesDetailView");const n=this.getOwnerComponent().getModel("modelV2");e.setModel(n);var r={lanes:[{id:"0",icon:"sap-icon://document",label:"Draft",position:0},{id:"1",icon:"sap-icon://approvals",label:"Approval",position:1},{id:"2",icon:"sap-icon://accept",label:"Completed",position:2}],nodes:[{id:"1",lane:"0",title:"Created",titleAbbreviation:"C",state:"Positive",stateText:"Done",children:["2"],texts:["Created by user"],highlighted:false,focused:true},{id:"2",lane:"1",title:"Approval in Progress",titleAbbreviation:"A",state:"Neutral",stateText:"Pending",children:["3"],texts:["Sent for approval"],highlighted:false,focused:false},{id:"3",lane:"2",title:"Completed",titleAbbreviation:"D",state:"Positive",stateText:"Finished",texts:["Approved and closed"],highlighted:false,focused:false}]};var i=new sap.ui.model.json.JSONModel(r);e.setModel(i,"ProcessFlow");var c=new sap.ui.model.json.JSONModel({files:[]});this.getView().setModel(c,"attachments")},onNavBack:function(){history.go(-1)},onClose:function(e){this.onCancel(e)},onEdit:async function(e){this._toggleEdit();var t=this.getModel("appView");t.setProperty("/CreateMode",false)},onOpenFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","MidColumnFullScreen");e.setProperty("/isFullPage",false)},onCloseFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","TwoColumnsMidExpanded");e.setProperty("/isFullPage",true)},onCloseDetailPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","OneColumn");e.setProperty("/isFullPage",true)},onFileSelectedV4:async function(e){var t=e.getParameter("files")[0];if(!t)return;var a=this.getView().getModel("modelV2");var o=this.getOwnerComponent().getModel();var s=a.getProperty("/Header/ID");var n=o.bindList(`/Invoice(ID='${s}',IsActiveEntity=false)/attachments`);var r=await n.create({filename:t.name});var i=this.getView().getModel("attachments");var c=i.getProperty("/files");c.push({fileName:t.name,uploadDate:(new Date).toLocaleString(),status:"Uploaded",contextPath:r.getPath()});i.refresh();sap.m.MessageToast.show("Upload complete.")},onDeleteAttachment:async function(e){const t=this.getOwnerComponent().getModel();const a=this.getView().getModel("attachments");const o=e.getSource().getParent();const s=o.getBindingContext("attachments");const n=s.getObject();if(n.contextPath){try{await t.delete(n.contextPath)}catch(e){sap.m.MessageToast.show("Delete failed: "+e.message);return}}const r=a.getProperty("/files");const i=r.indexOf(n);r.splice(i,1);a.refresh();sap.m.MessageToast.show("Attachment deleted.")},onFileSelectedV41:async function(e){const t=e.getParameter("files")[0];const a=this.getView();const o=this.getOwnerComponent().getModel();const s=a.getModel("CreateModel").getProperty("/Header/ID");await $.ajax({url:`/odata/v4/dashboard/`,type:"GET",headers:{"X-CSRF-Token":"Fetch"},success:(e,t,a)=>{this._csrfToken=a.getResponseHeader("X-CSRF-Token")}});await this._test(s,t);const n=await $.ajax({url:`/odata/v4/dashboard/Invoice(ID='${s}',IsActiveEntity=false)/attachments`,type:"GET",success:(e,t,a)=>{this.Response=e}});const r=n.ID;await this._uploadBinaryFile(s,r,t)},_test:function(e,t){return new Promise((a,o)=>{jQuery.ajax({url:"/odata/v4/dashboard/"+`Invoice(ID=${e},IsActiveEntity=false)/attachments`,type:"POST",data:JSON.stringify({filename:t.name}),contentType:"application/json",processData:false,success:function(e){a(e)},error:function(e){o(new Error(e.responseText))}})})},_uploadBinaryFile:function(e,t,a){const o=`/odata/v4/dashboard/Invoice_attachments(`+`up__ID=${e},ID=${t},IsActiveEntity=false)/content`;sap.ui.core.BusyIndicator.show();$.ajax({url:o,type:"PUT",data:a,processData:false,contentType:a.type,success:()=>{sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("File uploaded successfully!");this.getView().getModel("attachments").refresh()},error:e=>{sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("File upload failed.");console.error(e.responseText||e)}})},editDraftInitial:function(){return new Promise((e,t)=>{const a=this.getOwnerComponent().getModel();const o=this.getView();const s=o.getModel("CreateModel").getProperty("/Header/ID");const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=true)/draftEdit?$expand=DraftAdministrativeData`;jQuery.ajax({url:n,type:"POST",contentType:"application/json",processData:false,success:t=>e(t),error:o=>{const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=false)`;jQuery.ajax({url:n,type:"GET",success:t=>e(t),error:e=>t(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},uploadFile:function(e){const t=e.getParameter("files")[0];const a="Invoice";const s=this.getView();const n=s.getModel("CreateModel").getProperty("/Header/ID");const r={up__ID:n,filename:t.name,mimeType:t.type,note:"test"};const i=[r];let c=null;this.editDraftInitial().then(()=>this._createFileEntry(a,i)).then(e=>{this._sendFileContent(t,e,a);return this._updateFileNote("test",a)}).catch(e=>{c=e;this._showError("Failed while creating file entry",e)}).then(()=>new Promise(e=>setTimeout(e,3e3))).then(()=>this._prepareDraft()).then(()=>this._activateDraft()).then(()=>{if(!c){o.success("File uploaded successfully.")}else{this._showError("File upload failed",c)}}).catch(e=>{this._showError("Draft processing failed",e)})},_createFileEntry:function(e,t){return new Promise((a,o)=>{const s=this.getOwnerComponent().getModel();const n=this.getView();const r=n.getModel("CreateModel").getProperty("/Header/ID");jQuery.ajax({url:`${s.sServiceUrl}${e}(ID=${r},IsActiveEntity=false)/attachments`,type:"POST",data:JSON.stringify(t[0]),contentType:"application/json",Accept:"application/json",processData:false,success:(e,t,o)=>{if(e&&e.ID){a(e)}else{const e=o.getResponseHeader("Location");if(e){const t=e.match(/up__ID=([^) ,]+).*ID=([^) ,]+)/);const o=t?t[1]:null;const s=t?t[2]:null;a({ID:s})}else{a({})}}},error:e=>o(new Error(e.responseText||"File entry creation failed"))})})},_sendFileContent:function(e,t,a){const o=this.getOwnerComponent().getModel();this.attachmentID=t.ID;const s=this.getView();const n=s.getModel("CreateModel").getProperty("/Header/ID");const r=`${o.sServiceUrl}${a}_attachments(up__ID=${n},ID=${t.ID},IsActiveEntity=false)/content`;const i=this.byId("fileUploader");i.setUploadUrl(r);i.setHttpRequestMethod("PUT");i.setSendXHR(true);i.upload()},_updateFileNote:function(e,t){return new Promise((a,o)=>{const s=this.getOwnerComponent().getModel();const n=this.getView();const r=n.getModel("CreateModel").getProperty("/Header/ID");const i={note:e};jQuery.ajax({url:`${s.sServiceUrl}${t}_attachments(up__ID=${r},ID=${this.attachmentID},IsActiveEntity=false)`,type:"PATCH",data:JSON.stringify(i),contentType:"application/json",processData:false,success:a,error:e=>o(new Error(e.responseText||"Note update failed"))})})},_showError:function(e,t){const a=`${e}: ${t.message||t}`;console.error(a);o.error(a)},_prepareDraft:function(){return new Promise((e,t)=>{const a=this.getOwnerComponent().getModel();const o=this.getView();const s=o.getModel("CreateModel").getProperty("/Header/ID");const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=false)/draftPrepare`;jQuery.ajax({url:n,type:"POST",contentType:"application/json",processData:false,success:t=>e(t),error:o=>{const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=false)`;jQuery.ajax({url:n,type:"GET",success:t=>e(t),error:e=>t(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},_activateDraft:function(){return new Promise((e,t)=>{const a=this.getOwnerComponent().getModel();const o=this.getView();const s=o.getModel("CreateModel").getProperty("/Header/ID");const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=false)/draftActivate?$expand=DraftAdministrativeData`;jQuery.ajax({url:n,type:"POST",contentType:"application/json",processData:false,success:t=>e(t),error:o=>{const n=`${a.sServiceUrl}Invoice(ID=${s},IsActiveEntity=false)`;jQuery.ajax({url:n,type:"GET",success:t=>e(t),error:e=>t(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},onFileSelected:function(e){var t=e.getSource();var a=t.getFocusDomRef().files;if(!a||a.length===0){return}var o=a[0];var s=o.name;var n=(new Date).toLocaleString();var r=this.getView().getModel("attachments");var i=r.getProperty("/files");var c=i.some(e=>e.fileName===s);if(!c){i.push({fileName:s,uploadDate:n,status:"Pending"})}else{sap.m.MessageToast.show("This file is already listed.")}r.setProperty("/files",i)},onUploadPress:function(){var e=this.getView().getModel();var t=e.createEntry("/Invoice",{properties:{companyCode:"",fiscalYear:(new Date).getFullYear(),documentDate:new Date,postingDate:new Date,invGrossAmount:0,documentCurrency:"",supInvParty:"",InvoicingParty:""}});this.getView().getModel("appView").setProperty("/newContext",t);sap.m.MessageToast.show("New blank invoice added after upload.")},onSave:async function(){var e=this.getView();var t=e.getModel();var a=e.getBindingContext();var n=e.getModel("appView");try{if(t.hasPendingChanges()){await t.submitChanges({groupId:"CREATE",success:function(e){this._toggleEdit();s.show("Changes saved successfully!")},error:function(e){s.show("Error in saving Changes!")}})}else{s.show("Changes Already Saved")}}catch(e){console.error("Save failed:",e);o.error("Failed to save changes. Please check console logs for details.")}},_formatToODataDate:function(e){if(!e){var t=new Date;return"/Date("+t.getTime()+")/"}if(typeof e==="string"&&e.includes("/Date")){return e}var a=new Date(e);return"/Date("+a.getTime()+")/"},onSavePress:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel("CreateModel").getData();var t=this.getView().getModel();this._ValidatePayload(e);var a=this.getModel("appView");var o=a.getProperty("/CreateMode");var s={fiscalYear:e.Header.fiscalYear,companyCode:e.Header.companyCode,documentDate:this._formatToODataDate(e.Header.documentDate),postingDate:this._formatToODataDate(e.Header.postingDate),supInvParty:e.Header.supInvParty,documentCurrency_code:e.Header.documentCurrency_code,invGrossAmount:e.Header.invGrossAmount||"0.00",DocumentHeaderText:e.Header.DocumentHeaderText,PaymentTerms:e.Header.PaymentTerms,AccountingDocumentType:e.Header.AccountingDocumentType,InvoicingParty:e.Header.InvoicingParty,statusFlag:e.Header.statusFlag,to_InvoiceItem:e.Items.map(e=>({sup_InvoiceItem:e.sup_InvoiceItem,purchaseOrder:e.purchaseOrder,purchaseOrderItem:e.purchaseOrderItem,referenceDocument:e.referenceDocument,refDocFiscalYear:e.refDocFiscalYear,refDocItem:e.refDocItem,taxCode:e.taxCode,documentCurrency_code:e.documentCurrency_code,supInvItemAmount:e.supInvItemAmount||0,poQuantityUnit:e.poQuantityUnit,quantityPOUnit:e.quantityPOUnit,Plant:e.Plant,TaxJurisdiction:e.TaxJurisdiction,ProductType:e.ProductType}))};if(o){t.create("/Invoice",s,{success:function(e){sap.m.MessageToast.show("Invoice Created Successfully");this._toggleEdit();sap.ui.core.BusyIndicator.hide(0);sap.ui.getCore().getEventBus().publish("InvoiceChannel","ReloadList")}.bind(this),error:function(e){sap.m.MessageToast.show("Error Creating Invoice");sap.ui.core.BusyIndicator.hide(0)}})}else{this._InvGUID=this.getView().getModel("CreateModel").getData().Header.ID;$.ajax({url:"/odata/v2/dashboard/Invoice('ID="+this._InvGUID+"'"+"IsActiveEntity=false"+")",type:"PATCH",data:JSON.stringify(s),contentType:"application/json",headers:{"If-Match":"*",Accept:"application/json"},success:function(e){sap.m.MessageToast.show("Invoice updated successfully");this._toggleEdit();sap.ui.core.BusyIndicator.hide(0);sap.ui.getCore().getEventBus().publish("InvoiceChannel","ReloadList")}.bind(this),error:function(e){sap.m.MessageToast.show("Update failed");console.error(e.responseText);sap.ui.core.BusyIndicator.hide(0)}})}},_ValidatePayload:function(e){var t=[]},_onObjectMatched:function(e){sap.ui.core.BusyIndicator.hide();var t=e.getParameter("arguments").objectId;var a=this.getModel("filesDetailView");var o=this.getModel("appView");var s=this.getOwnerComponent();var n=s._oCreateContext;this.getModel("appView").setProperty("/layout",sap.f.LayoutType.TwoColumnsBeginExpanded);if(t==="new"||t==="copy"){this.getModel("appView").setProperty("/bProcessFlowVisible",false);if(!n){this.getRouter().navTo("files");return}this.getView().setBindingContext(n);o.setProperty("/isEditable",true);var r=this.byId("ObjectPageHeader");if(r){r.setObjectTitle("New Invoice")}return}else{this.getModel("appView").setProperty("/bProcessFlowVisible",true)}o.setProperty("/isEditable",false);delete s._oCreateContext;var i=this.getModel().createKey("/Invoice",{DocumentId:t});this.getView().bindElement({path:i,events:{change:this._onBindingChange.bind(this),dataRequested:function(){a.setProperty("/busy",true)},dataReceived:function(){a.setProperty("/busy",false)}}});const c=e.getParameter("arguments").ID;const d="/Invoice("+c+")";this.getView().bindElement({path:d,parameters:{expand:"to_InvoiceItem,to_InvoiceLogs"}})},_createEmptyInvoiceModel:function(){return new sap.ui.model.json.JSONModel({Header:{documentId:"",fiscalYear:"",companyCode:"",documentDate:"",postingDate:"",supInvParty:"",documentCurrency_code:"",invGrossAmount:"",DocumentHeaderText:"",PaymentTerms:"",AccountingDocumentType:"",InvoicingParty:"",statusFlag:"",mode:"CREATE"},Items:[{sup_InvoiceItem:"",purchaseOrder:"",purchaseOrderItem:"",referenceDocument:"",refDocFiscalYear:"",refDocItem:"",taxCode:"",documentCurrency_code:"",supInvItemAmount:"",poQuantityUnit:"",quantityPOUnit:"",Plant:"",TaxJurisdiction:"",ProductType:""}]})},_onObjectMatchedV2:function(e){sap.ui.core.BusyIndicator.hide();var t=e.getParameter("arguments").objectId;this._bEditMode=t!=="new";var a=this.getModel("filesDetailView");var o=this.getView().getModel("modelV2");var s=this.getModel("appView");this.getModel("appView").setProperty("/layout",sap.f.LayoutType.TwoColumnsBeginExpanded);if(t==="new"){this.getModel("appView").setProperty("/bProcessFlowVisible",false);var n=this._createEmptyInvoiceModel();this.getView().setModel(n,"CreateModel");s.setProperty("/isEditable",true);var r=this.byId("ObjectPageHeader");if(r){r.setObjectTitle("New Invoice")}return}else{this._InvGUID=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/bProcessFlowVisible",true);var i=this.getView().getModel();var c=e.getParameter("arguments").objectId;i.read("/Invoice("+c+")",{urlParameters:{$expand:"to_InvoiceItem"},success:e=>{var t={Header:{ID:e.ID,documentId:e.documentId,fiscalYear:e.fiscalYear,companyCode:e.companyCode,documentDate:e.documentDate,postingDate:e.postingDate,supInvParty:e.supInvParty,documentCurrency_code:e.documentCurrency_code,invGrossAmount:e.invGrossAmount||"0.00",DocumentHeaderText:e.DocumentHeaderText,PaymentTerms:e.PaymentTerms,AccountingDocumentType:e.AccountingDocumentType,InvoicingParty:e.InvoicingParty,statusFlag:e.statusFlag},Items:e.to_InvoiceItem.results.map(e=>({ID:e.ID,sup_InvoiceItem:e.sup_InvoiceItem,purchaseOrder:e.purchaseOrder,purchaseOrderItem:e.purchaseOrderItem,referenceDocument:e.referenceDocument,refDocFiscalYear:e.refDocFiscalYear,refDocItem:e.refDocItem,taxCode:e.taxCode,documentCurrency_code:e.documentCurrency_code,supInvItemAmount:e.supInvItemAmount,poQuantityUnit:e.poQuantityUnit,quantityPOUnit:e.quantityPOUnit||"0.00",Plant:e.Plant,TaxJurisdiction:e.TaxJurisdiction,ProductType:e.ProductType}))};var a=new sap.ui.model.json.JSONModel(t);this.getView().setModel(a,"CreateModel")}})}},oncreateItem:function(){var e=this.getModel("appView");e.setProperty("/isEditable",true);var t=this.getView().byId("ItemTable");var a=this.getView().getModel();var o=this.getView().getBindingContext();const s=a.createEntry(o.getPath()+"/to_InvoiceItem",{properties:{purchaseOrder:"",poQuantityUnit:"",quantityPOUnit:0,sup_InvoiceItem:"",supInvItemAmount:0,Plant:"",ProductType:"",TaxJurisdiction:"",taxCode:""}});const n=t.getBindingInfo("items").template.clone();n.setBindingContext(s);t.addItem(n);this._oNewItemCtx=s;sap.m.MessageToast.show("New row added")},onDiscardDraft:function(){var e=this.getView();var t=e.getModel();var a=e.getModel("appView");var o=e.byId("ItemTable");if(t.hasPendingChanges()){t.resetChanges()}var s=o.getItems();t.refresh(true);a.setProperty("/isEditable",false);if(a.getProperty("/layout")!=="TwoColumnsMidExpanded"){a.setProperty("/layout","TwoColumnsMidExpanded")}var n=o.getItems();if(n.length>0){o.setSelectedItem(n[0]);o.fireItemPress({listItem:n[0]})}sap.m.MessageToast.show("Changes discarded")},_onBindingChange:function(){var e=this.getModel("filesDetailView");var t=this.getView().getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("notFound");return}e.setProperty("/busy",false)},_toggleEdit:function(){var e=this.getModel("appView");var t=!e.getProperty("/isEditable");e.setProperty("/isEditable",t)}})});
//# sourceMappingURL=FilesDetail.controller.js.map