sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s,n,a){"use strict";return e.extend("zdashboard.controller.FilesDetail",{DELETED_LEVEL:"X",onInit:function(){var e=this.getView();var t=new s({busy:true,delay:0,editable:false,DELETED_LEVEL:this.DELETED_LEVEL,data:[],bProcessFlowVisible:true});this._InvGUID="00000000-0000-0000-0000-000000000000";var n=new sap.ui.model.json.JSONModel({Header:{documentId:"",fiscalYear:"",companyCode:"",documentDate:"",postingDate:"",supInvParty:"",documentCurrency_code:"",invGrossAmount:"",DocumentHeaderText:"",PaymentTerms:"",AccountingDocumentType:"",InvoicingParty:"",statusFlag:"",mode:""},Items:[{sup_InvoiceItem:"",purchaseOrder:"",purchaseOrderItem:"",referenceDocument:"",refDocFiscalYear:"",refDocItem:"",taxCode:"",documentCurrency_code:"",supInvItemAmount:"",poQuantityUnit:"",quantityPOUnit:"",Plant:"",TaxJurisdiction:"",ProductType:""}]});this._bEditMode;this.getView().setModel(n,"CreateModel");this.getRouter().getRoute("fileDetail").attachPatternMatched(this._onObjectMatchedV2,this);var a=this.getView().getBusyIndicatorDelay();this.setModel(t,"filesDetailView");const i=this.getOwnerComponent().getModel("modelV2");e.setModel(i);var o={lanes:[{id:"0",icon:"sap-icon://document",label:"Draft",position:0},{id:"1",icon:"sap-icon://approvals",label:"Approval",position:1},{id:"2",icon:"sap-icon://accept",label:"Completed",position:2}],nodes:[{id:"1",lane:"0",title:"Created",titleAbbreviation:"C",state:"Positive",stateText:"Done",children:["2"],texts:["Created by user"],highlighted:false,focused:true},{id:"2",lane:"1",title:"Approval in Progress",titleAbbreviation:"A",state:"Neutral",stateText:"Pending",children:["3"],texts:["Sent for approval"],highlighted:false,focused:false},{id:"3",lane:"2",title:"Completed",titleAbbreviation:"D",state:"Positive",stateText:"Finished",texts:["Approved and closed"],highlighted:false,focused:false}]};var r=new sap.ui.model.json.JSONModel(o);e.setModel(r,"ProcessFlow");var c=new sap.ui.model.json.JSONModel({files:[]});this.getView().setModel(c,"attachments");this._newCreatedOnce=false;this._aNewItemContexts=[]},onNavBack:function(){history.go(-1)},onClose:function(e){this.onCancel(e)},onEdit:async function(e){this._toggleEdit();var t=this.getModel("appView");t.setProperty("/CreateMode",false);this.editDraftInitial().then(function(e){var t=`/Invoice(ID=${e.ID},IsActiveEntity=${e.IsActiveEntity})`;this.getView().bindElement({path:t,parameters:{expand:"to_InvoiceItem,to_InvoiceLogs,attachments"},events:{dataRequested:function(){sap.ui.core.BusyIndicator.show()},dataReceived:function(){sap.ui.core.BusyIndicator.hide()}}})}.bind(this))},onOpenFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","MidColumnFullScreen");e.setProperty("/isFullPage",false)},onCloseFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","TwoColumnsMidExpanded");e.setProperty("/isFullPage",true)},onCloseDetailPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","OneColumn");e.setProperty("/isFullPage",true)},onFileSelectedV4:async function(e){var t=e.getParameter("files")[0];if(!t)return;var s=this.getView().getModel("modelV2");var n=this.getOwnerComponent().getModel();var a=s.getProperty("/Header/ID");var i=n.bindList(`/Invoice(ID='${a}',IsActiveEntity=false)/attachments`);var o=await i.create({filename:t.name});var r=this.getView().getModel("attachments");var c=r.getProperty("/files");c.push({fileName:t.name,uploadDate:(new Date).toLocaleString(),status:"Uploaded",contextPath:o.getPath()});r.refresh();sap.m.MessageToast.show("Upload complete.")},onDeleteAttachment:async function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("attachments");const n=e.getSource().getParent();const a=n.getBindingContext("attachments");const i=a.getObject();if(i.contextPath){try{await t.delete(i.contextPath)}catch(e){sap.m.MessageToast.show("Delete failed: "+e.message);return}}const o=s.getProperty("/files");const r=o.indexOf(i);o.splice(r,1);s.refresh();sap.m.MessageToast.show("Attachment deleted.")},editDraftInitial:function(){return new Promise((e,t)=>{const s=this.getOwnerComponent().getModel();const n=this.getView();const a=n.getBindingContext().getObject("ID");const i=`${s.sServiceUrl}Invoice(ID=${a},IsActiveEntity=true)/draftEdit?$expand=DraftAdministrativeData`;const o=this.byId("fileUploader");jQuery.ajax({url:i,type:"POST",contentType:"application/json",processData:false,success:t=>e(t),error:n=>{sap.ui.core.BusyIndicator.hide(0);const i=`${s.sServiceUrl}Invoice(ID=${a},IsActiveEntity=false)`;o.clear();jQuery.ajax({url:i,type:"GET",success:t=>e(t),error:e=>t(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},uploadFile:function(e){sap.ui.core.BusyIndicator.show(0);const t=e.getParameter("files")[0];const s="Invoice";const a=this.getView();const i=a.getBindingContext().getObject("ID");const o={up__ID:i,filename:t.name,mimeType:t.type,note:"test"};const r=[o];let c=null;const d=new FileReader;d.onload=e=>{const a=e.target.result;const i=this.getView().getModel("attachments");let o=i.getProperty("/files")||[];o.push({fileName:t.name,createdOn:(new Date).toLocaleDateString(),createdBy:"",notes:"test",fileContent:a});i.setProperty("/files",o);this._createFileEntry(s,r).then(e=>{this._sendFileContent(t,e,s);return this._updateFileNote("test",s)}).catch(e=>{c=e;const t=this.byId("fileUploader");t.clear();this._showError("Failed while creating file entry",e)}).then(()=>new Promise(e=>setTimeout(e,3e3))).then(()=>{if(!c){n.success("File uploaded successfully.")}else{this._showError("File upload failed",c)}}).catch(e=>{const t=this.byId("fileUploader");t.clear();this._showError("Draft processing failed",e)})};d.readAsDataURL(t)},_createFileEntry:function(e,t){return new Promise((s,n)=>{const a=this.getOwnerComponent().getModel();const i=this.getView();const o=i.getBindingContext().getObject("ID");jQuery.ajax({url:`${a.sServiceUrl}${e}(ID=${o},IsActiveEntity=false)/attachments`,type:"POST",data:JSON.stringify(t[0]),contentType:"application/json",Accept:"application/json",processData:false,success:(e,t,n)=>{if(e&&e.ID){s(e)}else{const e=n.getResponseHeader("Location");if(e){const t=e.match(/up__ID=([^) ,]+).*ID=([^) ,]+)/);const n=t?t[1]:null;const a=t?t[2]:null;s({ID:a})}else{s({})}}},error:function(e){sap.ui.core.BusyIndicator.hide(0);n(new Error(e.responseText||"File entry creation failed"))}})})},_sendFileContent:function(e,t,s){const n=this.getOwnerComponent().getModel();this.attachmentID=t.ID;const a=this.getView();const i=a.getBindingContext().getObject("ID");const o=`${n.sServiceUrl}${s}_attachments(up__ID=${i},ID=${t.ID},IsActiveEntity=false)/content`;const r=this.byId("fileUploader");r.setUploadUrl(o);r.setHttpRequestMethod("PUT");r.setSendXHR(true);r.upload();sap.ui.core.BusyIndicator.hide(0)},_updateFileNote:function(e,t){return new Promise((s,n)=>{const a=this.getOwnerComponent().getModel();const i=this.getView();const o=i.getBindingContext().getObject("ID");const r={note:e};jQuery.ajax({url:`${a.sServiceUrl}${t}_attachments(up__ID=${o},ID=${this.attachmentID},IsActiveEntity=false)`,type:"PATCH",data:JSON.stringify(r),contentType:"application/json",processData:false,success:s,error:e=>n(new Error(e.responseText||"Note update failed"))})})},_showError:function(e,t){const s=this.byId("fileUploader");sap.ui.core.BusyIndicator.hide(0);s.clear();const a=`${e}: ${t.message||t}`;console.error(a);n.error(a)},_prepareDraft:function(e){return new Promise((t,s)=>{const n=this.getOwnerComponent().getModel();const a=this.getView();var i=a.getBindingContext().getObject("ID");if(!i){i=e}const o=`${n.sServiceUrl}Invoice(ID=${i},IsActiveEntity=false)/draftPrepare`;jQuery.ajax({url:o,type:"POST",contentType:"application/json",processData:false,success:e=>t(e),error:e=>{const a=`${n.sServiceUrl}Invoice(ID=${i},IsActiveEntity=false)`;jQuery.ajax({url:a,type:"GET",success:e=>t(e),error:e=>s(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},_activateDraft:function(e){return new Promise((t,s)=>{const n=this.getOwnerComponent().getModel();const i=this.getView();var o=i.getBindingContext().getObject("ID");if(!o){o=e}const r=`${n.sServiceUrl}Invoice(ID=${o},IsActiveEntity=false)/draftActivate?$expand=DraftAdministrativeData`;jQuery.ajax({url:r,type:"POST",contentType:"application/json",processData:false,success:e=>{sap.ui.core.BusyIndicator.hide(0);this._toggleEdit();sap.ui.getCore().getEventBus().publish("InvoiceChannel","ReloadList");var s=new sap.ui.model.json.JSONModel({files:e.attachments||[]});i.setModel(s,"attachments");var n=i.byId("uploadedFilesTable");var n=i.byId("uploadedFilesTable");if(n.getBinding("items")){n.getBinding("items").refresh()}a.show("Draft activated and attachments loaded.");t(e);this.getRouter().navTo("files")},error:e=>{const a=`${n.sServiceUrl}Invoice(ID=${o},IsActiveEntity=false)`;jQuery.ajax({url:a,type:"GET",success:e=>t(e),error:e=>s(new Error(e.responseText||"Unable to start or fetch draft"))})}})})},onOpenAttachment:function(e){const t=e.getSource().getBindingContext("Attachments");const s=t.getProperty("id");const n=t.getProperty("fileName");if(!this._pdfViewer){this._pdfViewer=new sap.m.PDFViewer({title:n,width:"auto",height:"800px"});this.getView().addDependent(this._pdfViewer)}else{this._pdfViewer.setTitle(n)}this._pdfViewer.open()},onFileSelected:function(e){var t=e.getSource();var s=t.getFocusDomRef().files;if(!s||s.length===0){return}var n=s[0];var a=n.name;var i=(new Date).toLocaleString();var o=this.getView().getModel("attachments");var r=o.getProperty("/files");var c=r.some(e=>e.fileName===a);if(!c){r.push({fileName:a,uploadDate:i,status:"Pending"})}else{sap.m.MessageToast.show("This file is already listed.")}o.setProperty("/files",r)},_formatToODataDate:function(e){if(!e){var t=new Date;return"/Date("+t.getTime()+")/"}if(typeof e==="string"&&e.includes("/Date")){return e}var s=new Date(e);return"/Date("+s.getTime()+")/"},onSavePress:async function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel().getData();var t=this.getView().getBindingContext().getPath();var s=this.getView().getModel();var n=this.getModel("appView");var a=n.getProperty("/CreateMode");var i=this.getView().getModel().getData(t);var o=this.byId("ItemTable");if(a){const e=this._aNewItemContexts.map(e=>e.getPath());i.to_InvoiceItem=this._aNewItemContexts.map(e=>e.getObject())}else{const e=o.getBinding("items").getContexts().map(e=>e.getObject());const t=(this._aNewItemContexts||[]).map(e=>e.getObject());i.to_InvoiceItem=[...e,...t]}if(a){s.create("/Invoice",i,{success:function(e){sap.m.MessageToast.show("Invoice Created Successfully");this._aNewItemContexts=[];this._prepareDraft(e.ID).then(()=>this._activateDraft(e.ID))}.bind(this),error:function(e){sap.m.MessageToast.show("Error Creating Invoice");sap.ui.core.BusyIndicator.hide(0)}})}else{$.ajax({url:"/odata/v2/dashboard/Invoice(ID="+"'"+i.ID+"',"+"IsActiveEntity=false"+")",type:"POST",data:JSON.stringify(i),contentType:"application/json",headers:{"If-Match":"*",Accept:"application/json"},success:function(e){sap.m.MessageToast.show("Invoice updated successfully");this._toggleEdit();sap.ui.core.BusyIndicator.hide(0);sap.ui.getCore().getEventBus().publish("InvoiceChannel","ReloadList");this._aNewItemContexts=[]}.bind(this),error:function(e){sap.m.MessageToast.show("Update failed");console.error(e.responseText);sap.ui.core.BusyIndicator.hide(0)}})}},_ValidatePayload:function(e){var t=[]},_createEmptyInvoiceModel:function(){return new sap.ui.model.json.JSONModel({Header:{documentId:"",fiscalYear:"",companyCode:"",documentDate:"",postingDate:"",supInvParty:"",documentCurrency_code:"",invGrossAmount:"",DocumentHeaderText:"",PaymentTerms:"",AccountingDocumentType:"",InvoicingParty:"",statusFlag:"",mode:"CREATE"},Items:[{sup_InvoiceItem:"",purchaseOrder:"",purchaseOrderItem:"",referenceDocument:"",refDocFiscalYear:"",refDocItem:"",taxCode:"",documentCurrency_code:"",supInvItemAmount:"",poQuantityUnit:"",quantityPOUnit:"",Plant:"",TaxJurisdiction:"",ProductType:""}]})},_onObjectMatchedV2:function(e){sap.ui.core.BusyIndicator.hide();var t=e.getParameter("arguments").objectId;this._bEditMode=t!=="new";var s=this.getModel("filesDetailView");var n=this.getOwnerComponent().getModel("modelV2");var a=this.getModel("appView");if(n.hasPendingChanges()){n.resetChanges()}if(this.getView().getParent()&&this.getView().getParent().getParent().getParent()&&this.getView().getParent().getParent().getParent().getId()!=="container-zdashboard---files"){if(t==="new"){var i=n.createEntry("/Invoice",{properties:{IsActiveEntity:false,HasActiveEntity:false},expand:"to_InvoiceItem"});this.getView().bindElement({path:i.getPath(),parameters:{expand:"to_InvoiceItem"},urlParameters:{$expand:"to_InvoiceItem"}});this.oncreateItem();var o=this.getModel("appView");o.setProperty("/isEditable",true);o.setProperty("/bProcessFlowVisible",false);this.byId("ObjectPageHeader").setObjectTitle("New Invoice")}else{this._newCreatedOnce=false;this._InvGUID=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/bProcessFlowVisible",true);var r=this.getView().getModel();var c=e.getParameter("arguments").objectId;r.read("/Invoice("+c+")",{urlParameters:{$expand:"to_InvoiceItem"},success:e=>{var t={Header:{ID:e.ID,documentId:e.documentId,fiscalYear:e.fiscalYear,companyCode:e.companyCode,documentDate:e.documentDate,postingDate:e.postingDate,supInvParty:e.supInvParty,documentCurrency_code:e.documentCurrency_code,invGrossAmount:e.invGrossAmount||"0.00",DocumentHeaderText:e.DocumentHeaderText,PaymentTerms:e.PaymentTerms,AccountingDocumentType:e.AccountingDocumentType,InvoicingParty:e.InvoicingParty,statusFlag:e.statusFlag},Items:e.to_InvoiceItem.results.map(e=>({ID:e.ID,sup_InvoiceItem:e.sup_InvoiceItem,purchaseOrder:e.purchaseOrder,purchaseOrderItem:e.purchaseOrderItem,referenceDocument:e.referenceDocument,refDocFiscalYear:e.refDocFiscalYear,refDocItem:e.refDocItem,taxCode:e.taxCode,documentCurrency_code:e.documentCurrency_code,supInvItemAmount:e.supInvItemAmount,poQuantityUnit:e.poQuantityUnit,quantityPOUnit:e.quantityPOUnit||"0.00",Plant:e.Plant,TaxJurisdiction:e.TaxJurisdiction,ProductType:e.ProductType}))};var s=new sap.ui.model.json.JSONModel(t);this.getView().setModel(s,"CreateModel")}})}}},oncreateItem:function(){var e=this.getModel("appView");e.setProperty("/isEditable",true);var t=this.getView().byId("ItemTable");var s=this.getView().getModel();var n=this.getView().getBindingContext();const a=s.createEntry(n.getPath()+"/to_InvoiceItem",{properties:{purchaseOrder:"",poQuantityUnit:"",quantityPOUnit:0,sup_InvoiceItem:"",supInvItemAmount:0,Plant:"",ProductType:"",TaxJurisdiction:"",taxCode:""}});const i=t.getBindingInfo("items").template.clone();i.setBindingContext(a);t.addItem(i);this._aNewItemContexts.push(a);sap.m.MessageToast.show("New row added")},onDiscardDraft:function(){var e=this.getView();var t=e.getModel();var s=e.getModel("appView");var n=e.byId("ItemTable");if(t.hasPendingChanges()){t.resetChanges()}var a=n.getItems();t.refresh(true);s.setProperty("/isEditable",false);if(s.getProperty("/layout")!=="TwoColumnsMidExpanded"){s.setProperty("/layout","TwoColumnsMidExpanded")}var i=n.getItems();if(i.length>0){n.setSelectedItem(i[0]);n.fireItemPress({listItem:i[0]})}sap.m.MessageToast.show("Changes discarded")},_onBindingChange:function(){var e=this.getModel("filesDetailView");var t=this.getView().getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("notFound");return}e.setProperty("/busy",false)},_toggleEdit:function(){var e=this.getModel("appView");var t=!e.getProperty("/isEditable");e.setProperty("/isEditable",t)}})});
//# sourceMappingURL=FilesDetail.controller.js.map