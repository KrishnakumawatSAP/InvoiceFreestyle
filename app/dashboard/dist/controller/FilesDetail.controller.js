sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s,a,i){"use strict";return e.extend("zdashboard.controller.FilesDetail",{DELETED_LEVEL:"X",onInit:function(){var e=this.getView();var t=new s({busy:true,delay:0,editable:false,DELETED_LEVEL:this.DELETED_LEVEL,data:[],bProcessFlowVisible:true});this.getRouter().getRoute("fileDetail").attachPatternMatched(this._onObjectMatched,this);var a=this.getView().getBusyIndicatorDelay();this.setModel(t,"filesDetailView");const i=this.getOwnerComponent().getModel("modelV2");e.setModel(i);var o={lanes:[{id:"0",icon:"sap-icon://document",label:"Draft",position:0},{id:"1",icon:"sap-icon://approvals",label:"Approval",position:1},{id:"2",icon:"sap-icon://accept",label:"Completed",position:2}],nodes:[{id:"1",lane:"0",title:"Created",titleAbbreviation:"C",state:"Positive",stateText:"Done",children:["2"],texts:["Created by user"],highlighted:false,focused:true},{id:"2",lane:"1",title:"Approval in Progress",titleAbbreviation:"A",state:"Neutral",stateText:"Pending",children:["3"],texts:["Sent for approval"],highlighted:false,focused:false},{id:"3",lane:"2",title:"Completed",titleAbbreviation:"D",state:"Positive",stateText:"Finished",texts:["Approved and closed"],highlighted:false,focused:false}]};var n=new sap.ui.model.json.JSONModel(o);e.setModel(n,"ProcessFlow");var r=new sap.ui.model.json.JSONModel({files:[]});this.getView().setModel(r,"attachments")},onNavBack:function(){history.go(-1)},onClose:function(e){this.onCancel(e)},onEdit:async function(e){this._toggleEdit();const t=this.getView();const s=t.getModel();const a=t.getBindingContext()},onOpenFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","MidColumnFullScreen");e.setProperty("/isFullPage",false)},onCloseFullPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","TwoColumnsMidExpanded");e.setProperty("/isFullPage",true)},onCloseDetailPage:function(){var e=this.getView().getModel("appView");e.setProperty("/layout","OneColumn");e.setProperty("/isFullPage",true)},onFileSelected:function(e){var t=e.getSource();var s=t.getFocusDomRef().files;if(!s||s.length===0){return}var a=s[0];var i=a.name;var o=(new Date).toLocaleString();var n=this.getView().getModel("attachments");var r=n.getProperty("/files");var l=r.some(e=>e.fileName===i);if(!l){r.push({fileName:i,uploadDate:o,status:"Pending"})}else{sap.m.MessageToast.show("This file is already listed.")}n.setProperty("/files",r)},onUploadPress:function(){var e=this.getView().getModel();var t=e.createEntry("/Invoice",{properties:{companyCode:"",fiscalYear:(new Date).getFullYear(),documentDate:new Date,postingDate:new Date,invGrossAmount:0,documentCurrency:"",supInvParty:"",InvoicingParty:""}});this.getView().getModel("appView").setProperty("/newContext",t);sap.m.MessageToast.show("New blank invoice added after upload.")},onAddUser:function(e){var t=this.getView().getBindingContext().getPath();var s=this.getModel().getProperty(t+"/Id");var a=this.getModel().createEntry("/FileUsers",{properties:{FileId:s},refreshAfterChange:false,groupId:"changes"});var i=this.byId("idFilesUsersColumnListItem").clone();i.bindElement(a.getPath());this.byId("idFilesUsersTable").addItem(i)},onDeleteUser:function(e){var t=e.getParameter("listItem").getBindingContext().getPath();this.getModel().setProperty(t+"/Level",this.DELETED_LEVEL);this.getModel().remove(t,{groupId:"changes"})},onShowMessages:function(e){var t=e.getSource();this.openFragment("zdashboard.view.MessagePopover",{id:"idMessagePopover",openBy:t})},onCancel:function(e){if(!this.getModel().hasPendingChanges()){this.onConfirm(e);return}var t=e.getSource();this.openFragment("zdashboard.view.ConfirmationPopover",{id:"idConfirmationPopover",openBy:t,title:"As modificações serão perdidas. Deseja continuar?"})},onConfirm:function(e){this.getModel().resetChanges();sap.ui.getCore().getMessageManager().removeAllMessages();var s=this.byId("idConfirmationPopover");var a;if(s){s.close();a=s.getOpenedBy()}this.getModel("appView").setProperty("/isEditable",true);var i=a?a.getId():e.getSource().getId();if(i.includes("idCloseButton")){this.getModel("appView").setProperty("/layout",t.OneColumn);this.getRouter().navTo("files")}},onSave:async function(){var e=this.getView();var t=e.getModel();var s=e.getBindingContext();var o=e.getModel("appView");try{if(t.hasPendingChanges()){await t.submitChanges({success:function(e){this._toggleEdit();i.show("Changes saved successfully!")},error:function(e){i.show("Error in saving Changes!")}})}else{i.show("Changes Already Saved")}}catch(e){console.error("Save failed:",e);a.error("Failed to save changes. Please check console logs for details.")}},onSavePressV4:async function(){var e=this.getView();var t=e.getModel();var s=e.getModel("appView");try{await t.submitBatch("updateGroup");sap.m.MessageToast.show("Saved successfully!");s.setProperty("/isEditable",false)}catch(e){sap.m.MessageBox.error("Error while saving: "+e.message)}},onSavePressV41:async function(){const e=this.getView();const t=e.getModel();const s=e.getBindingContext();if(!s){sap.m.MessageBox.error("No draft context found.");return}if(t.hasPendingChanges()){await t.submitBatch("$auto");await t.submitBatch("draftGroup")}try{await t.submitBatch("$auto").catch(()=>{});var a=s.getProperty("IsActiveEntity");var i;if(a){i=t.bindContext(`${s.getPath()}/DashboardService.draftEdit(...)`)}else{i=t.bindContext(`${s.getPath()}/DashboardService.draftActivate(...)`)}const o=await i.execute("draftGroup");await t.submitBatch("draftGroup");let n;if(a){n=s.getPath().replace("IsActiveEntity=true","IsActiveEntity=false")}else{n=s.getPath().replace("IsActiveEntity=false","IsActiveEntity=true")}e.bindElement({path:n,parameters:{$$updateGroupId:"draftGroup"},events:{change:()=>sap.m.MessageToast.show("Invoice saved successfully!")}});oAppViewModel.setProperty("/isEditable",false)}catch(e){console.error("Save failed:",e);sap.m.MessageBox.error("Failed to save invoice. See console for details.")}},onSave1:function(){var e=this.getView();var t=e.getModel();var s=e.getModel("appView");var a=e.byId("ItemTable");var i=this.getView().byId("InvoiceSmartTable");var o=this;t.submitChanges({success:function(){sap.m.MessageToast.show("Invoice saved successfully");s.setProperty("/isEditable",false);a.getItems().forEach(function(e){var s=e.getBindingContext();if(s&&s.bCreated){t.deleteCreatedEntry(s)}});this.getRouter().navTo("files");t.refresh(true);s.refresh(true);if(s.getProperty("/layout")!=="TwoColumnsMidExpanded"){s.setProperty("/layout","TwoColumnsMidExpanded")}o._bHandlingNew=false;delete o.getOwnerComponent()._oCreateContext},error:function(){sap.m.MessageBox.error("Error while saving invoice. Please try again.")}})},onSave1:function(e){var t=this.getView().getModel();var s=this.getModel("appView");var a=this;t.submitChanges({success:function(e){if(!t.hasPendingChanges()){sap.m.MessageToast.show("Invoice updated successfully");s.setProperty("/isEditable",false);a._bHandlingNew=false;delete a.getOwnerComponent()._oCreateContext}},error:function(e){sap.m.MessageBox.error("Error while updating invoice. Please try again.")}})},_onObjectMatched:function(e){sap.ui.core.BusyIndicator.hide();var t=e.getParameter("arguments").objectId;var s=this.getModel("filesDetailView");var a=this.getModel("appView");var i=this.getOwnerComponent();var o=i._oCreateContext;this.getModel("appView").setProperty("/layout",sap.f.LayoutType.TwoColumnsBeginExpanded);if(t==="new"||t==="copy"){this.getModel("appView").setProperty("/bProcessFlowVisible",false);if(!o){this.getRouter().navTo("files");return}this.getView().setBindingContext(o);a.setProperty("/isEditable",true);var n=this.byId("ObjectPageHeader");if(n){n.setObjectTitle("New Invoice")}return}else{this.getModel("appView").setProperty("/bProcessFlowVisible",true)}a.setProperty("/isEditable",false);delete i._oCreateContext;var r=this.getModel().createKey("/Invoice",{DocumentId:t});this.getView().bindElement({path:r,events:{change:this._onBindingChange.bind(this),dataRequested:function(){s.setProperty("/busy",true)},dataReceived:function(){s.setProperty("/busy",false)}}});const l=e.getParameter("arguments").ID;const d="/Invoice("+l+")";this.getView().bindElement({path:d,parameters:{expand:"to_InvoiceItem,to_InvoiceLogs"}})},oncreateItem:function(){var e=this.getModel("appView");e.setProperty("/isEditable",true);var t=this.getView().byId("ItemTable");var s=this.getView().getModel();var a=this.getView().getBindingContext();const i=s.createEntry(a.getPath()+"/to_InvoiceItem",{properties:{purchaseOrder:"",poQuantityUnit:"",quantityPOUnit:0,sup_InvoiceItem:"",supInvItemAmount:0,Plant:"",ProductType:"",TaxJurisdiction:"",taxCode:""}});const o=t.getBindingInfo("items").template.clone();o.setBindingContext(i);t.addItem(o);this._oNewItemCtx=i;sap.m.MessageToast.show("New row added")},onDiscardDraftV4:async function(){const e=this.getView();const t=e.getModel();const s=e.getBindingContext();this._toggleEdit();if(s.getProperty("IsActiveEntity")){i.show("Nothing to cancel.");return}await t.delete(s.getPath(),{groupId:"draftGroup"});await t.submitBatch("draftGroup");const a=s.getPath().replace("IsActiveEntity=false","IsActiveEntity=true");e.bindElement({path:a,model:"Invoice"});i.show("Draft discarded.")},onDiscardDraft:function(){var e=this.getView();var t=e.getModel();var s=e.getModel("appView");var a=e.byId("ItemTable");if(t.hasPendingChanges()){t.resetChanges()}var i=a.getItems();i.forEach(function(e){var s=e.getBindingContext();if(s&&s.bCreated){t.deleteCreatedEntry(s)}});t.refresh(true);s.setProperty("/isEditable",false);if(s.getProperty("/layout")!=="TwoColumnsMidExpanded"){s.setProperty("/layout","TwoColumnsMidExpanded")}var o=a.getItems();if(o.length>0){a.setSelectedItem(o[0]);a.fireItemPress({listItem:o[0]})}sap.m.MessageToast.show("Changes discarded")},_onBindingChange:function(){var e=this.getModel("filesDetailView");var t=this.getView().getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("notFound");return}e.setProperty("/busy",false)},_toggleEdit:function(){var e=this.getModel("appView");var t=!e.getProperty("/isEditable");e.setProperty("/isEditable",t)}})});
//# sourceMappingURL=FilesDetail.controller.js.map